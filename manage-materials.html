<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricision - Manage Ingredients / materials</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous"/>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet"
    />
    <link rel="icon" href="images/Submark 1.png" />
    <link rel="stylesheet" href="css/homepage/navbar.css" />
    <link rel="stylesheet" href="css/main.css" />
    </head>
<body>
    
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
            <div class="toast-header">
                <strong class="me-auto" id="toastHeader">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>
    <header>
        <nav class="navbar navbar-expand-lg navbar-color fixed-top bg-dark">
            <div class="container">
            <a class="navbar-brand" href="homepage.html">
                <img src="images/Secondary 1.png" alt="Logo" style="height: 40px; width: auto;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav nav-underline">
                
                <li class="nav-item"><a class="nav-link-grow" href="homepage.html">Home</a></li>
                
                <li class="nav-item dropdown">
                <a class="nav-link-grow-drop dropdown-toggle" href="#" id="productsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Products
                </a>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="productsDropdown">
                    <li><a class="dropdown-item" href="add-product-homepage.html">Add New Product</a></li>
                    <li><a class="dropdown-item" href="edit-product.html">Edit Product Details/Recipe</a></li>
                </ul>
                </li>
        
                <li class="nav-item dropdown">
                <a class="nav-link-grow-drop dropdown-toggle active" href="#" id="materialsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Materials
                </a>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="materialsDropdown">
                    <li><a class="dropdown-item" href="add-material.html">Add New Material</a></li>
                    <li><a class="dropdown-item" href="manage-materials.html">Manage Material Costs</a></li>
                </ul>
                </li>
        
                <li class="nav-item">
                <a class="nav-link-grow" href="manage.html">Dashboard</a>
                </li>
                
                <li class="nav-item dropdown">
                <a class="nav-link-grow-drop dropdown-toggle" href="#" id="helpDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Help
                </a>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="helpDropdown">
                    <li><a class="dropdown-item" href="homepage.html#how-pricision-works">How Pricision Works</a></li>
                    <li><a class="dropdown-item" href="homepage.html#aboutus">About Us</a></li>
                    <li><a class="dropdown-item" href="homepage.html#terms">Terms & Terminology</a></li>
                    <li><a class="dropdown-item" href="homepage.html#step-by-step">Step by Step</a></li>
                    <li><a class="dropdown-item" href="homepage.html#developer">Developers</a></li>
                </ul>
                </li>
                
            </ul>
            </div>
        </div>
    </nav>
</header>
    <div class="container py-5">
        <h2 class="mb-4 custom-top">Raw Material Price Management</h2>
        <p>Use this page to quickly update purchase prices and recalculate the Unit Cost for all materials. <Strong>Be careful when changing Purchase Price, Shipping, and Qty per Pack and Base Unit.</Strong></p>
        <div id="materialsCardContainer" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <div id="noMaterials" class="mt-4 alert alert-info d-none">No raw materials found.</div>
        </div>
    </div>

    <footer class="text-center py-3 footer-bg text-white manage-material-footer">
        <div class="container">
            <p class="mb-0">© 2025 Pricision. All rights reserved.</p>
            <a href="privacy.html" class="btn privacy-color btn-link">Privacy Policy</a>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- TOAST SETUP ---
        const liveToastEl = document.getElementById('liveToast');
        const toastHeaderEl = document.getElementById('toastHeader');
        const toastBodyEl = document.getElementById('toastBody');
        const toastBootstrap = bootstrap.Toast.getOrCreateInstance(liveToastEl); 

        function showToast(message, type) {
            let headerText = '';
            
            if (type === 'success') {
                headerText = 'Success';
            } else if (type === 'danger') {
                headerText = 'Action Required';
            } else {
                headerText = 'Information';
            }

            toastHeaderEl.textContent = headerText;
            toastBodyEl.textContent = message;
            
            liveToastEl.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-info');
            liveToastEl.classList.add(`text-bg-${type}`);

            toastBootstrap.show();
        }
        // --- END TOAST SETUP ---

        const unitOptions = [
            { value: "gram", text: "Grams (g)" },
            { value: "kilogram", text: "Kilograms (kg)" },
            { value: "ounce", text: "Ounces (oz)" },
            { value: "pound", text: "Pounds (lbs)" },
            { value: "milliliter", text: "Milliliters (ml)" },
            { value: "liter", text: "Liters (l)" },
            { value: "teaspoon", text: "Teaspoons (tsp)" },
            { value: "tablespoon", text: "Tablespoons (tbsp)" },
            { value: "piece", text: "Pieces" },
            { value: "unit", text: "Units" },
            { value: "head", text: "Heads" },
            { value: "slice", text: "Slices" },
            { value: "pack", text: "Packs" },
            { value: "bag", text: "Bags" },
            { value: "box", text: "Boxes" },
            { value: "centimeter", text: "Centimeters (cm)" },
            { value: "meter", text: "Meter (m)" },
            { value: "inch", text: "Inches (in)" },
        ];

        document.addEventListener('DOMContentLoaded', () => {
            loadMaterials();
        });

        function createUnitDropdown(selectedValue) {
            let optionsHtml = '';
            unitOptions.forEach(option => {
                const selected = option.value === selectedValue ? 'selected' : '';
                optionsHtml += `<option value="${option.value}" ${selected}>${option.text}</option>`;
            });
            return `<select class="form-select form-select-sm unit-input" data-field="units">${optionsHtml}</select>`;
        }

        function loadMaterials() {
            const materials = JSON.parse(localStorage.getItem('materials')) || [];
            const cardContainer = document.getElementById('materialsCardContainer');
            const noMaterials = document.getElementById('noMaterials');
            cardContainer.innerHTML = ''; 

            if (materials.length === 0) {
                noMaterials.classList.remove('d-none');
                return;
            }
            noMaterials.classList.add('d-none');

            materials.forEach(material => {
                
                const cardCol = document.createElement('div');
                cardCol.className = 'col';
                cardCol.setAttribute('data-id', material.id);
                const unitDropdown = createUnitDropdown(material.units);
                cardCol.innerHTML = `
                    <div class="card h-100 shadow-sm border-info">
                        <div class="card-header custom-bg">
                            <h5 class="mb-0">${material.name}</h5>
                            <small class="text-secondary">Unit: <span class="current-unit-display">${material.units}</span></small>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                                        
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <label>Supplier</label>
                                    <input type="text" class="form-control form-control-sm w-50 supplier-input text-end" value="${material.supplier || ''}" data-field="supplier">
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <label>Purchase Price (₱)</label>
                                    <input type="number" class="form-control form-control-sm w-50 price-input text-end" value="${material.purchasePrice}" data-field="purchasePrice" step="0.01" min="0">
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <label>Shipping (₱)</label>
                                    <input type="number" class="form-control form-control-sm w-50 shipping-input text-end" value="${material.shippingFee}" data-field="shippingFee" step="0.01" min="0">
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <label>Qty per Pack</label>
                                    <input type="number" class="form-control form-control-sm w-50 qty-input text-end" value="${material.qtyPerPack}" data-field="qtyPerPack" step="0.01" min="1">
                                </li>                        
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                    <label class="fw-bold">Change Base Unit</label>
                                    <div class="w-50">${unitDropdown}</div>
                                </li>
                            </ul>
                            <div class="mt-3 text-center p-2 rounded bg-light">
                                <p class="mb-0 fw-bold">Calculated Unit Cost</p>
                                <strong class="unit-cost-display text-success fs-4">₱${material.unitCost.toFixed(4)}</strong> / <span class="unit-label">${material.units}</span>
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <button class="btn btn-sm btn-success save-material-btn" data-id="${material.id}">Save Changes</button>
                            <button class="btn btn-sm btn-outline-danger delete-material-btn" data-id="${material.id}">Delete</button>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(cardCol);
            });
            
            // Event delegation now handles the Save and Delete buttons
            cardContainer.removeEventListener('input', updateRowCost); // Remove old listener
            cardContainer.removeEventListener('change', updateRowCost); // Remove old listener
            cardContainer.removeEventListener('click', handleDelete); // Remove old listener

            cardContainer.addEventListener('input', updateRowCost); // Keep instant calculation
            cardContainer.addEventListener('change', updateRowCost); // Keep instant calculation

            // Add new unified click listener
            cardContainer.addEventListener('click', handleCardActions);
        }
        
        // New handler for both save and delete actions
        function handleCardActions(e) {
            const target = e.target;
            const id = target.getAttribute('data-id');
            if (!id) return;

            if (target.classList.contains('delete-material-btn')) {
                handleDelete(id);
            } else if (target.classList.contains('save-material-btn')) {
                saveSingleMaterial(id);
            }
        }

        // Updates the Unit Cost display instantly when an input/unit changes
        function updateRowCost(e) {
            if (!e.target.classList.contains('price-input') && 
                !e.target.classList.contains('qty-input') &&
                !e.target.classList.contains('shipping-input') &&
                !e.target.classList.contains('unit-input')) return; 

            const cardCol = e.target.closest('.col');
            
            const purchasePrice = parseFloat(cardCol.querySelector('[data-field="purchasePrice"]').value) || 0;
            const qtyPerPack = parseFloat(cardCol.querySelector('[data-field="qtyPerPack"]').value) || 1;
            const shippingFee = parseFloat(cardCol.querySelector('[data-field="shippingFee"]').value) || 0;
            const newUnit = cardCol.querySelector('[data-field="units"]').value; 

            // Update the unit display labels
            cardCol.querySelector('.current-unit-display').textContent = newUnit;
            cardCol.querySelector('.unit-label').textContent = newUnit;
            
            const calculatedQtyPerPack = qtyPerPack === 0 ? 1 : qtyPerPack; 
            const unitCost = (purchasePrice + shippingFee) / calculatedQtyPerPack;
            
            cardCol.querySelector('.unit-cost-display').textContent = `₱${unitCost.toFixed(4)}`;
        }

        // NEW FUNCTION: Saves only the material associated with the clicked card ID
        function saveSingleMaterial(id) {
            const cardCol = document.querySelector(`.col[data-id="${id}"]`);
            if (!cardCol) {
                showToast('Error: Material card not found.', 'danger');
                return;
            }

            let materials = JSON.parse(localStorage.getItem('materials')) || [];
            let materialIndex = materials.findIndex(m => String(m.id) === String(id));
            if (materialIndex === -1) return;

            // Get current values from inputs in the card
            const supplier = cardCol.querySelector('[data-field="supplier"]').value.trim(); 
            const purchasePrice = parseFloat(cardCol.querySelector('[data-field="purchasePrice"]').value) || 0;
            const qtyPerPack = parseFloat(cardCol.querySelector('[data-field="qtyPerPack"]').value) || 1;
            const shippingFee = parseFloat(cardCol.querySelector('[data-field="shippingFee"]').value) || 0;
            const units = cardCol.querySelector('[data-field="units"]').value; 

            const calculatedQtyPerPack = qtyPerPack === 0 ? 1 : qtyPerPack; 
            const newUnitCost = (purchasePrice + shippingFee) / calculatedQtyPerPack;

            // Update the material object in the array
            materials[materialIndex] = {
                ...materials[materialIndex], 
                supplier: supplier,
                purchasePrice: purchasePrice,
                qtyPerPack: qtyPerPack,
                shippingFee: shippingFee,
                units: units, 
                unitCost: parseFloat(newUnitCost.toFixed(4))
            };

            localStorage.setItem('materials', JSON.stringify(materials));
            showToast(`${materials[materialIndex].name} saved successfully! Unit cost recalculated.`, 'success'); 
        }
        
        // Refactored handleDelete to accept ID directly
        function handleDelete(id) {
            const deletedMaterial = (JSON.parse(localStorage.getItem('materials')) || []).find(m => String(m.id) === String(id));
            const materialName = deletedMaterial ? deletedMaterial.name : 'Material';

            if (confirm(`Are you sure you want to delete ${materialName}? This will affect products that use it.`)) {
                let materials = JSON.parse(localStorage.getItem('materials')) || [];
                materials = materials.filter(m => String(m.id) !== String(id));
                localStorage.setItem('materials', JSON.stringify(materials));
                showToast(`${materialName} deleted.`, 'danger'); 
                loadMaterials();
            }
        }
    </script>
</body>
</html>