<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricision - Recipe Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="icon" href="images/Submark 1.png">
    <link rel="stylesheet" href="css/homepage/navbar.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
            <div class="toast-header">
                <strong class="me-auto" id="toastHeader">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                </div>
        </div>
    </div>
    <header>
        <nav class="navbar navbar-expand-lg navbar-color fixed-top bg-dark">
            <div class="container">
            <a class="navbar-brand" href="homepage.html">
                <img src="images/Secondary 1.png" alt="Logo" style="height: 40px; width: auto;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav nav-underline">
                
                <li class="nav-item"><a class="nav-link-grow" href="homepage.html">Home</a></li>
                
                <li class="nav-item dropdown">
                <a class="nav-link-grow-drop dropdown-toggle" href="#" id="productsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Products
                </a>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="productsDropdown">
                    <li><a class="dropdown-item" href="add-product-homepage.html">Add New Product</a></li>
                    <li><a class="dropdown-item" href="edit-product.html">Edit Product Details/Recipe</a></li>
                </ul>
                </li>
        
                <li class="nav-item dropdown">
                <a class="nav-link-grow-drop dropdown-toggle" href="#" id="materialsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Materials
                </a>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="materialsDropdown">
                    <li><a class="dropdown-item" href="add-material.html">Add New Material</a></li>
                    <li><a class="dropdown-item" href="manage-materials.html">Manage Material Costs</a></li>
                </ul>
                </li>
        
                <li class="nav-item">
                <a class="nav-link-grow" href="manage.html">Dashboard</a>
                </li>
                
                <li class="nav-item dropdown">
                <a class="nav-link-grow-drop dropdown-toggle" href="#" id="helpDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Help
                </a>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="helpDropdown">
                    <li><a class="dropdown-item" href="homepage.html#how-pricision-works">How Pricision Works</a></li>
                    <li><a class="dropdown-item" href="homepage.html#aboutus">About Us</a></li>
                    <li><a class="dropdown-item" href="homepage.html#terms">Terms & Terminology</a></li>
                    <li><a class="dropdown-item" href="homepage.html#step-by-step">Step by Step</a></li>
                    <li><a class="dropdown-item" href="homepage.html#developer">Developers</a></li>
                </ul>
                </li>
                
            </ul>
            </div>
        </div>
        </nav>
    </header>
    <div class="container py-5">
        <h2 class="mb-4 custom-top">Recipe Builder for <span id="productNameDisplay">...</span></h2>
        <div id="alertBox" class="alert d-none mt-3" role="alert"></div>

        <form id="recipeForm" class="row g-3 mb-5">
            <div class="col-md-6">
                <label for="batchYield" class="form-label">Recipe Batch Yield (Final Units)</label>
                <input type="number" id="batchYield" class="form-control" min="1" required placeholder="Example: 50 (This recipe makes 50 bags)"/>
            </div>
            
            <h4 class="mt-4">Materials Used in Recipe</h4>
            <div id="materialsContainer" class="col-12">
            </div>

            <div class="col-12">
                <button type="button" id="addMaterialBtn" class="btn btn-success">Add Ingredient/Material</button>
            </div>

            <div class="col-12 mt-4">
                <button type="submit" class="btn btn-primary">Calculate & Save Recipe</button>
                <a href="manage.html" class="btn btn-outline-secondary">Go to Management</a>
            </div>
        </form>

        <div class="card p-4 mt-5">
            <h5>Cost Summary</h5>
            <p>Total Recipe Cost: <strong id="totalRecipeCost">â‚±0.00</strong></p>
            <p>COGS per Product Unit: <strong id="cogsPerUnit">â‚±0.00</strong></p>
            <p>Recommended Selling Price: <strong id="sellingPriceDisplay">â‚±0.00</strong></p>
        </div>
    </div>
    <footer class="text-center py-3 footer-bg text-white add-recipe-footer">
        <div class="container">
            <p class="mb-0">Â© 2025 Pricision. All rights reserved.</p>
            <a href="privacy.html" class="btn privacy-color btn-link">Privacy Policy</a>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id') || localStorage.getItem("currentProductId");
    
        const materials = JSON.parse(localStorage.getItem("materials")) || [];
        const products = JSON.parse(localStorage.getItem("products")) || [];
        const currentProduct = products.find(p => String(p.id) === String(productId));
    
        const materialsContainer = document.getElementById('materialsContainer');
        const addMaterialBtn = document.getElementById('addMaterialBtn');
        const recipeForm = document.getElementById('recipeForm');
    
        // --- TOAST SETUP ---
        const liveToastEl = document.getElementById('liveToast');
        const toastHeaderEl = document.getElementById('toastHeader');
        const toastBodyEl = document.getElementById('toastBody');
        const toastBootstrap = bootstrap.Toast.getOrCreateInstance(liveToastEl);
    
        function showToast(message, isError = false) {
            toastHeaderEl.textContent = isError ? 'Input Error' : 'Success';
            toastBodyEl.textContent = message;
            
            // Set toast background color
            liveToastEl.classList.remove('text-bg-success', 'text-bg-danger');
            liveToastEl.classList.add(isError ? 'text-bg-danger' : 'text-bg-success');
    
            toastBootstrap.show();
        }
        // --- END TOAST SETUP ---
    
    
        if (currentProduct) {
            document.getElementById('productNameDisplay').textContent = currentProduct.name;
        } else {
            document.getElementById('productNameDisplay').textContent = 'Product Error';
            recipeForm.style.display = 'none';
        }
    
        let materialCount = 0;
    
        function findRowByMaterialId(materialId) {
            const rows = materialsContainer.querySelectorAll('.material-row');
            let targetRow = null;
            rows.forEach(row => {
                const select = row.querySelector('.material-select');
                if (String(select.value) === String(materialId)) {
                    targetRow = row;
                }
            });
            return targetRow;
        }
    
        // --- UPDATED VALIDATION FUNCTION: CLEARS INPUT ON EXCEED ---
        function validateUsageQuantity(event) {
            const target = event.target;
            if (!target.classList.contains('usage-qty')) return;
    
            const row = target.closest('.material-row');
            const select = row.querySelector('.material-select');
            const materialId = select.value;
            const usageQty = parseFloat(target.value);
    
            const selectedMaterial = materials.find(m => String(m.id) === String(materialId));
    
            if (selectedMaterial) {
                const maxLimit = parseFloat(selectedMaterial.qtyPerPack);
                
                if (!isNaN(maxLimit) && maxLimit > 0 && usageQty > maxLimit) {
                    const materialName = selectedMaterial.name;
                    const unit = selectedMaterial.units || 'units';
    
                    const errorMessage = `Quantity for ${materialName} (${usageQty.toFixed(3)} ${unit}) exceeds the Net Wt./Quantity Per Pack limit of ${maxLimit.toFixed(2)} ${unit}. Please enter a valid amount.`;
                    
                    showToast(errorMessage, true); 
                    
                    // ðŸ‘‰ This is the new line: Clear the input
                    target.value = ''; 
                    
                    target.classList.add('is-invalid');
                    setTimeout(() => {
                        target.classList.remove('is-invalid');
                    }, 5000);
    
                } else {
                    target.classList.remove('is-invalid');
                }
            }
        }
        // --- END UPDATED VALIDATION FUNCTION ---
    
        function addMaterialRow(materialId = '', usageQty = '') {
            if (materials.length === 0) {
                showToast('No raw materials found. Redirecting to Add Material page.', true);
    
                setTimeout(function() {
                    window.location.href = 'add-material.html';
                }, 1500);
                return;
            }
    
        materialCount++;
        const row = document.createElement('div');
        row.classList.add('row', 'g-2', 'mb-3', 'material-row', 'align-items-end');
        row.id = `materialRow-${materialCount}`;
        row.innerHTML = `
                    <div class="col-md-5">
                        <select class="form-select material-select" name="materialSelect-${materialCount}" required>
                            <option value="" disabled ${materialId === '' ? 'selected' : ''}>Select Ingredient/Material</option>
                            ${materials.map(m => `<option value="${m.id}" data-cost="${m.unitCost}" ${String(m.id) === String(materialId) ? 'selected' : ''}>${m.name} (â‚±${m.unitCost.toFixed(4)} / ${m.units})</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="number" class="form-control usage-qty" name="usageQty-${materialCount}" min="0.001" step="0.001" required placeholder="Net Wt./Quantity Used (in base unit)" value="${usageQty}"/>
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <strong class="material-cost-display">â‚±0.00</strong>
                    </div>
                    <div class="col-md-1 d-flex justify-content-end px-2"> 
                        <button type="button" class="btn btn-danger btn-sm remove-material align-item-end">X</button>
                    </div>
                `;
                materialsContainer.appendChild(row);
            }
    
        const allRecipes = JSON.parse(localStorage.getItem('recipes')) || [];
        const existingRecipe = allRecipes.find(r => String(r.productId) === String(productId));
    
        if (existingRecipe) {
            document.getElementById('batchYield').value = existingRecipe.batchYield;
            existingRecipe.materials.forEach(m => {
                const material = materials.find(mat => String(mat.id) === String(m.materialId));
                if(material){
                    addMaterialRow(m.materialId, m.usageQty);
                }
            });
            calculateCosts(); 
        } else {
            addMaterialRow();
        }
    
        addMaterialBtn.addEventListener('click', () => addMaterialRow());
        materialsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-material')) {
                e.target.closest('.material-row').remove();
                calculateCosts();
            }
        });
        
        materialsContainer.addEventListener('input', (e) => {
            validateUsageQuantity(e); 
            calculateCosts();
        });
        materialsContainer.addEventListener('change', calculateCosts); 
        document.getElementById('batchYield').addEventListener('input', calculateCosts);
        
        function calculateCosts() {
            const batchYield = parseFloat(document.getElementById('batchYield').value) || 0;
            let totalRecipeCost = 0;
            const rows = materialsContainer.querySelectorAll('.material-row');
            const recipeMaterials = [];
    
            rows.forEach(row => {
                const select = row.querySelector('.material-select');
                const qtyInput = row.querySelector('.usage-qty');
                const costDisplay = row.querySelector('.material-cost-display');
                const materialId = select.value;
                const usageQty = parseFloat(qtyInput.value) || 0;
    
                if (materialId) {
                    const selectedOption = select.options[select.selectedIndex];
                    const unitCost = parseFloat(selectedOption.getAttribute('data-cost'));
                    const materialCost = unitCost * usageQty;
                    totalRecipeCost += materialCost;
    
                    costDisplay.textContent = `â‚±${materialCost.toFixed(2)}`;
    
                    recipeMaterials.push({ materialId: materialId, usageQty: usageQty });
                } else {
                    costDisplay.textContent = 'â‚±0.00';
                }
            });
    
            document.getElementById('totalRecipeCost').textContent = `â‚±${totalRecipeCost.toFixed(2)}`;
            let cogsPerUnit = 0;
            if (batchYield > 0) { cogsPerUnit = totalRecipeCost / batchYield; }
            document.getElementById('cogsPerUnit').textContent = `â‚±${cogsPerUnit.toFixed(2)}`;
            
            let sellingPrice = 0;
            const P = parseFloat(currentProduct.productMargin) / 100;
            if (currentProduct.priceMethod === 'profitMargin') {
                sellingPrice = cogsPerUnit / (1 - P);
            } else if (currentProduct.priceMethod === 'markUp') {
                sellingPrice = cogsPerUnit * (1 + P);
            }
            document.getElementById('sellingPriceDisplay').textContent = `â‚±${sellingPrice.toFixed(2)}`;
            
            return { totalRecipeCost, cogsPerUnit, sellingPrice, batchYield, recipeMaterials };
        }
    
        recipeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const calculationData = calculateCosts();
    
            if (calculationData.cogsPerUnit <= 0) {
                showToast('Calculation failed. Ensure Batch Yield and all material quantities are valid.', true);
                return;
            }
    
            // --- FINAL MAX USAGE CHECK (Against qtyPerPack) ---
            let validationFailed = false;
            for (const materialUsage of calculationData.recipeMaterials) {
                const materialId = materialUsage.materialId;
                const requiredQty = materialUsage.usageQty;
                const materialDetails = materials.find(m => String(m.id) === String(materialId));
                const maxLimit = materialDetails ? parseFloat(materialDetails.qtyPerPack) : null; 
    
                if (!isNaN(maxLimit) && maxLimit > 0 && requiredQty > maxLimit) {
                    showToast(`Submission Failed: The quantity for ${materialDetails.name} exceeds the Net Wt./Quantity Per Pack limit of ${maxLimit.toFixed(2)} ${materialDetails.units}. Please correct the highlighted field.`, true);
                    
                    const failedRow = findRowByMaterialId(materialId);
                    if (failedRow) {
                        failedRow.querySelector('.usage-qty').classList.add('is-invalid');
                    }
                    validationFailed = true;
                    break;
                }
            }
            if (validationFailed) {
                return; // Stop form submission
            }
            // --- END FINAL CHECK ---
    
    
            const recipe = {
                productId: productId,
                batchYield: calculationData.batchYield,
                materials: calculationData.recipeMaterials,
                cogsPerUnit: calculationData.cogsPerUnit,
                sellingPrice: calculationData.sellingPrice,
            };
    
            let recipes = JSON.parse(localStorage.getItem('recipes')) || [];
            const existingIndex = recipes.findIndex(r => String(r.productId) === String(productId));
            
            if (existingIndex > -1) {
                recipes[existingIndex] = recipe;
                showToast('Recipe updated successfully!');
            } else {
                recipes.push(recipe);
                showToast('Recipe saved successfully!');
            }
    
            localStorage.setItem('recipes', JSON.stringify(recipes));
            
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const productIndex = products.findIndex(p => String(p.id) === String(productId));
            if (productIndex > -1) {
                products[productIndex].cogs = calculationData.cogsPerUnit.toFixed(2);
                products[productIndex].sellingPrice = calculationData.sellingPrice.toFixed(2);
                localStorage.setItem('products', JSON.stringify(products));
            }
    
            setTimeout(() => {
                window.location.href = 'manage.html';
            }, 800);
        });
        
        function showAlert(msg, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = 'alert alert-' + type;
            alertBox.textContent = msg;
            alertBox.classList.remove('d-none');
            setTimeout(() => alertBox.classList.add('d-none'), 3000);
        }
        
    </script>
</body>
</html>